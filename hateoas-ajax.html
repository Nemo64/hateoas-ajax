<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="../core-ajax/core-ajax.html"/>

<polymer-element hidden name="hateoas-ajax" extends="core-ajax" attributes="linkProperty, embeddedProperty">
    <script>
        //noinspection JSUnusedGlobalSymbols
        Polymer({
            linkProperty: '_links',
            embeddedProperty: '_embedded',
            handleAs: 'json',

            createSubInstance: function () {
                var request = document.createElement(this.nodeName);
                request.linkProperty = this.linkProperty;
                request.embeddedProperty = this.embeddedProperty;
                request.handleAs = this.handleAs;
                request.headers = this.headers;
                request.contentType = this.contentType;
                request.auto = false;
                return request;
            },

            responseChanged: function (oldValue, newValue) {
                this.process(newValue);
            },

            process: function (value) {
                if (value instanceof Array) {
                    value.forEach(this._modifyObject, this);
                } else if (value instanceof Object) {
                    this._modifyObject(value);
                }
            },

            _modifyObject: function (object) {
                this._processEmbeddedProperties(object);
                this._processLinkProperties(object);
            },

            _hideProperty: function (object, property) {
                var value = object[property];

                delete object[property];
                Object.defineProperty(object, property, {
                    enumerable: false,
                    configurable: false,
                    value: value
                });
            },

            _processEmbeddedProperties: function (object) {
                var embedded = object[this.embeddedProperty];
                if (!(embedded instanceof Object)) {
                    return;
                }

                // hide the property as it is not really a value
                this._hideProperty(object, this.embeddedProperty);

                Object.keys(embedded).forEach(function (embeddedProperty) {

                    // modify the object as if it were a response
                    this.process(embedded[embeddedProperty]);

                    // don't overwrite anything
                    if (embeddedProperty in object) {
                        return;
                    }

                    Object.defineProperty(object, embeddedProperty, {
                        enumerable: false,
                        configurable: true,
                        value: embedded[embeddedProperty]
                    });
                }, this);
            },

            _processLinkProperties: function (object) {
                var links = object[this.linkProperty];
                if (!(links instanceof Object)) {
                    return;
                }

                // hide the property as it is not really a value
                this._hideProperty(object, this.linkProperty);

                Object.keys(links).forEach(function (linkProperty) {
                    // don't overwrite anything
                    if (linkProperty in object) {
                        return;
                    }

                    var attributes = links[linkProperty];
                    this._createLinkGetMethod(object, linkProperty, attributes);
                    this._createLinkPutMethod(object, linkProperty, attributes);
                    this._createLinkPostMethod(object, linkProperty, attributes);
                    this._createLinkDeleteMethod(object, linkProperty, attributes);

                }, this);
            },

            _createLinkGetMethod: function (object, name, attributes) {
                var isRequestStarted = false;
                var request = null;
                var initiator = this;

                // define a getter to trigger the request
                Object.defineProperty(object, name, {
                    enumerable: false,
                    configurable: true,
                    get: function () {
                        if (isRequestStarted) {
                            return null;
                        }

                        request = initiator.createSubInstance();
                        request.url = attributes.href;
                        request.method = 'get';

                        // replace by value after the request is done
                        request.addEventListener('core-complete', function () {
                            Object.defineProperty(object, name, {
                                enumerable: false,
                                configurable: true,
                                value: request.response
                            });
                        });

                        request.go();
                        isRequestStarted = true;

                        return null;
                    },
                    set: function (value) {
                        request.abort();

                        delete this[name];
                        this[name] = value;
                    }
                });
            },

            _createLinkPostMethod: function (object, name, attributes) {
                this._createLinkBodyMethod('post', object, name, attributes);
            },

            _createLinkPutMethod: function (object, name, attributes) {
                this._createLinkBodyMethod('put', object, name, attributes);
            },

            _composeMethodName: function (method, name) {
                return method + name.substr(0, 1).toUpperCase() + name.substr(1);
            },

            _createLinkBodyMethod: function (method, object, name, attributes) {
                var methodName = this._composeMethodName(method, name);
                var initiator = this;

                Object.defineProperty(object, methodName, {
                    enumerable: false,
                    configurable: false,
                    value: function (data) {
                        var request = initiator.createSubInstance();
                        request.url = attributes.href;
                        request.method = method;
                        request.contentType = 'application/json';
                        request.body = JSON.stringify(data);
                        request.go();

                        // todo: if this name was already used for get, it can be automatically updated

                        return request;
                    }
                });
            },

            _createLinkDeleteMethod: function (object, name, attributes) {
                var methodName = this._composeMethodName('delete', name);
                var initiator = this;

                Object.defineProperty(object, methodName, {
                    enumerable: false,
                    configurable: false,
                    value: function (data) {
                        var request = initiator.createSubInstance();
                        request.url = attributes.href;
                        request.method = 'delete';
                        request.params = data;
                        request.go();

                        // todo: if this name was already used for get, it should be deleted

                        return request;
                    }
                });
            }
        });
    </script>
</polymer-element>