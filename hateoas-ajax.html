<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="../iron-ajax/iron-ajax-behavior.html"/>

<dom-module id="hateoas-ajax">
    <script>
//        var oldFire = Polymer.Base.fire;
//        Polymer.Base.fire = function () { console.log(arguments); oldFire.apply(this, arguments); };

        //noinspection JSUnusedGlobalSymbols
        Polymer({
            is: 'hateoas-ajax',

            // we want iron ajax behavior
            behaviors: [Polymer.IronAjaxBehavior],

            properties: {

                linkProperty: {
                    type: String,
                    value: '_links'
                },

                embeddedProperty: {
                    type: String,
                    value: '_embedded'
                }
            },

            observers: [
                'responseChanged(lastResponse)'
            ],

            createSubInstance: function () {
                var request = document.createElement(this.nodeName);
                request.linkProperty = this.linkProperty;
                request.embeddedProperty = this.embeddedProperty;
                request.headers = this.headers;
                request.auto = false;
                return request;
            },

            responseChanged: function (newValue) {
                this.process(newValue);
            },

            process: function (value) {
                if (value instanceof Array) {
                    value.forEach(this._modifyObject, this);
                } else if (value instanceof Object) {
                    this._modifyObject(value);
                }
            },

            _modifyObject: function (object, index) {
                this._processEmbeddedProperties(object, index);
                this._processLinkProperties(object, index);
            },

            _hideProperty: function (object, property) {
                var value = object[property];

                delete object[property];
                Object.defineProperty(object, property, {
                    enumerable: false,
                    configurable: false,
                    value: value
                });
            },

            _processEmbeddedProperties: function (object) {
                var embedded = object[this.embeddedProperty];
                if (!(embedded instanceof Object)) {
                    return;
                }

                // hide the property as it is not really a value
                this._hideProperty(object, this.embeddedProperty);

                Object.keys(embedded).forEach(function (embeddedProperty) {

                    // modify the object as if it were a response
                    this.process(embedded[embeddedProperty]);

                    // don't overwrite anything
                    if (embeddedProperty in object) {
                        return;
                    }

                    Object.defineProperty(object, embeddedProperty, {
                        enumerable: false,
                        configurable: true,
                        value: embedded[embeddedProperty]
                    });
                }, this);
            },

            _processLinkProperties: function (object, index) {
                var links = object[this.linkProperty];
                if (!(links instanceof Object)) {
                    return;
                }

                // hide the property as it is not really a value
                this._hideProperty(object, this.linkProperty);

                Object.keys(links).forEach(function (linkProperty) {
                    // don't overwrite anything
                    if (linkProperty in object) {
                        return;
                    }

                    var attributes = links[linkProperty];
                    this._createLinkGetMethod(object, index, linkProperty, attributes);
                    this._createLinkPutMethod(object, index, linkProperty, attributes);
                    this._createLinkPostMethod(object, index, linkProperty, attributes);
                    this._createLinkDeleteMethod(object, index, linkProperty, attributes);

                }, this);
            },

            _createLinkGetMethod: function (object, index, propertyName, attributes) {
                var initiator = this;
                var ajaxStorageField = propertyName + 'GetRequest';

                var ajax = initiator.createSubInstance();
                ajax.url = attributes.href;
                ajax.method = 'get';

                Object.defineProperty(object, ajaxStorageField, {
                    enumerable: false,
                    configurable: false,
                    writable: false,
                    value: ajax
                });

                var fullObjectPath = 'lastResponse.';
                if (index != null) {
                    fullObjectPath += index + '.';
                }
                fullObjectPath += propertyName;

                var loadProperty = function () {
                    if (ajax.loading) {
                        return;
                    }

                    // replace by value after the request is done
                    ajax.addEventListener('response', function (e) {

                        Object.defineProperty(object, propertyName, {
                            enumerable: false,
                            configurable: true,
                            value: ajax.lastResponse
                        });
                        initiator.notifyPath(fullObjectPath, ajax.lastResponse);

                        // also forward future changes
                        ajax.addEventListener('last-response-changed', function (e) {
                            var path = e.detail.path.replace('lastResponse', fullObjectPath);
                            initiator.notifyPath(path, e.detail.value);
                        });
                    });

                    ajax.generateRequest();
                };

                // define a getter to trigger the request
                Object.defineProperty(object, propertyName, {
                    enumerable: false,
                    configurable: true,
                    get: loadProperty,
                    set: function (value) {
                        // if the property is explicitly set
                        // abort any request and set it directly
                        ajax.discardRequest(ajax.lastRequest);

                        delete this[propertyName];
                        this[propertyName] = value;
                    }
                });

                // also define a way to load the values explicitly (this won't be overwritten after the request)
                var getMethodName = this._composeMethodName('get', propertyName);
                Object.defineProperty(object, getMethodName, {
                    enumerable: false,
                    configurable: false,
                    value: function () {
                        loadProperty();
                        return ajax;
                    }
                });
            },

            _createLinkPostMethod: function (object, index, name, attributes) {
                this._createLinkBodyMethod('post', object, name, attributes);
            },

            _createLinkPutMethod: function (object, index, name, attributes) {
                this._createLinkBodyMethod('put', object, name, attributes);
            },

            _composeMethodName: function (method, name) {
                return method + name.substr(0, 1).toUpperCase() + name.substr(1);
            },

            _createLinkBodyMethod: function (method, object, name, attributes) {
                var methodName = this._composeMethodName(method, name);
                var initiator = this;

                Object.defineProperty(object, methodName, {
                    enumerable: false,
                    configurable: false,
                    value: function (data) {
                        var request = initiator.createSubInstance();
                        request.url = attributes.href;
                        request.method = method;
                        request.contentType = 'application/json';
                        request.body = JSON.stringify(data);
                        request.generateRequest();

                        return request;
                    }
                });
            },

            _createLinkDeleteMethod: function (object, index, name, attributes) {
                var methodName = this._composeMethodName('delete', name);
                var initiator = this;

                Object.defineProperty(object, methodName, {
                    enumerable: false,
                    configurable: false,
                    value: function (data) {
                        var request = initiator.createSubInstance();
                        request.url = attributes.href;
                        request.method = 'delete';
                        request.params = data;
                        request.generateRequest();

                        return request;
                    }
                });
            }
        });
    </script>
</dom-module>